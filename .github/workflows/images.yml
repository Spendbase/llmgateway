name: images

on:
  release:
    types: [published]
  push:
    branches:
      - main
      - hotfix
      - feat/ci-semver
  pull_request:
    paths:
      - "**/package.json"
      - "**/tsconfig.json"
      - "pnpm-lock.yaml"
      - "infra/**"
      - ".github/workflows/images.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.set-tag.outputs.IMAGE_TAG }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set image tag
        id: set-tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            # Get current version from repository variable
            CURRENT_VERSION="${{ vars.BUILD_VERSION }}"
            if [[ -z "$CURRENT_VERSION" ]]; then
              CURRENT_VERSION="0.0.0"
            fi

            # Increment patch version (e.g., 0.0.0 -> 0.0.1)
            IFS='.' read -r -a VERSION_PARTS <<< "$CURRENT_VERSION"
            MAJOR="${VERSION_PARTS[0]}"
            MINOR="${VERSION_PARTS[1]}"
            PATCH="${VERSION_PARTS[2]}"
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"

            # Update the repository variable with new version
            gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "repos/${{ github.repository }}/actions/variables/BUILD_VERSION" \
              -f "value=$NEW_VERSION" || echo "Failed to update BUILD_VERSION variable"

            echo "IMAGE_TAG=v${NEW_VERSION}" >> $GITHUB_OUTPUT
            echo "Build version: v${NEW_VERSION} (was: v${CURRENT_VERSION})"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            SHORT_SHA=$(git rev-parse --short HEAD)
            echo "IMAGE_TAG=pr-${SHORT_SHA}" >> $GITHUB_OUTPUT
          else
            if [[ ! "${{ github.event.release.tag_name }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9_-]+)*$ ]]; then
              echo "Invalid tag name for Docker: ${{ github.event.release.tag_name }}"
              exit 1
            fi
            echo "IMAGE_TAG=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          fi

  build:
    needs: setup
    if: |
      (github.event_name != 'pull_request' && needs.setup.result == 'success') ||
      (github.event_name == 'pull_request')
    runs-on: k8s-arm64
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        # app: [api, gateway, playground, ui, docs, worker, admin]
        app: [docs]
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-central-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build, tag, and push Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ needs.setup.outputs.image_tag }}
        run: |
          docker build \
            -f infra/split.dockerfile \
            --target ${{ matrix.app }} \
            --build-arg APP_VERSION=${{ github.event_name == 'pull_request' && 'pr-test' || needs.setup.outputs.image_tag }} \
            -t $ECR_REGISTRY/llmgateway/${{ matrix.app }}:$IMAGE_TAG \
            ${{ github.event_name != 'pull_request' && '--push' || '' }} \
            .

      - name: Tag as latest (non-PR only)
        if: github.event_name != 'pull_request'
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ needs.setup.outputs.image_tag }}
        run: |
          docker tag $ECR_REGISTRY/llmgateway/${{ matrix.app }}:$IMAGE_TAG $ECR_REGISTRY/llmgateway/${{ matrix.app }}:latest
          docker push $ECR_REGISTRY/llmgateway/${{ matrix.app }}:latest

  test:
    runs-on: k8s-arm64
    needs:
      - setup
      - build
    if: |
      always() &&
      needs.setup.result == 'success' &&
      needs.build.result == 'success'
    permissions:
      contents: read
      packages: read
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-central-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Pull Docker images for testing
        if: github.event_name != 'pull_request'
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ needs.setup.outputs.image_tag }}
        run: |
          for app in api gateway playground ui docs worker admin; do
            echo "Pulling $app image..."
            docker pull $ECR_REGISTRY/llmgateway/$app:$IMAGE_TAG
          done

      - name: Test split Docker images
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ needs.setup.outputs.image_tag }}
        run: |
          chmod +x .github/test-split-docker.sh
          .github/test-split-docker.sh $ECR_REGISTRY/llmgateway $IMAGE_TAG
